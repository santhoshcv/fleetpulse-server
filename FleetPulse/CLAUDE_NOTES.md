# FleetPulse Web Portal - Development Notes
# READ THIS FIRST if session breaks - contains full context

## Project Location
/Users/santhoshvargheese/Projects/fleetpulse/FleetPulse/

## What This Is
Next.js 14 web portal for Cloud Telematics fleet management SaaS.
Generated by bolt.new, being wired up to production backend by Claude Code.

## Backend
- GPS Server: Python TCP on 164.90.223.18:23000
- Protocols: TFMS90 (text) + Teltonika Codec 8E (binary)
- Database: Supabase (PostgreSQL)

## Supabase Production Credentials
URL: https://ypxlpqylmxddrvhasmst.supabase.co
ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlweGxwcXlsbXhkZHJ2aGFzbXN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMzM3MjAsImV4cCI6MjA4NjgwOTcyMH0.6UYQzZSMFne8CdugAwqJhjBTIe-8YP8fL1jQeM4YJTw
NOTE: .env.local has correct credentials. The .env file has WRONG bolt.new credentials - ignore it.

## Database Tables (DO NOT ALTER SCHEMA)
### devices
- device_id TEXT PK (e.g. "TFMS90_100", "860000000000001")
- protocol TEXT ("tfms90" or "teltonika")
- imei VARCHAR, short_device_id INTEGER (TFMS90 only, range 100-999)
- firmware_version, sim_iccid, is_active, last_seen, created_at

### telemetry_data
- id UUID PK, device_id FK
- message_type: TD, TS, TE, HB, FLF, FLD, HA2, HB2, HC2, OS3, codec_0x8
- timestamp, latitude, longitude, speed(km/h), heading, fuel_level
- battery_voltage, odometer, gsm_signal, io_elements(jsonb), raw_data

## Live Devices
- TFMS90_100: TFMS90 protocol, IMEI 867762040399040, short_device_id=100
- 860000000000001: Teltonika protocol
- Both have real trip data from 2026-02-17 morning commute in Doha

## Trip Logic
- Trip START = message_type "TS"
- Trip TRACKING = message_type "TD" (every 3s while moving)
- Trip END = message_type "TE"
- Group by device_id, order by timestamp

## Brand (Cloud Telematics)
Colors: Primary #00AEEF, Silver #B3B3B3, Dark #2D2D2D, Gold #F5C400
Fonts: Bodoni Moda (headings), Carme (body)

## Completed Tasks
- [x] Task 1: .env.local, lib/supabase.ts, lib/types.ts
- [x] Task 2: Fonts updated (Bodoni Moda + Carme), brand colors already in tailwind
- [x] Task 3: Wire real data to ALL pages:
  - [x] app/admin/devices/page.tsx - real device inventory (Supabase query, search, auto-refresh 30s)
  - [x] app/dashboard/vehicles/page.tsx - real vehicle list + speed/position from TD, auto-refresh 15s
  - [x] app/dashboard/trips/page.tsx - real trips via TS→TD→TE sequence (duration, max/avg speed, record count)
  - [x] app/admin/page.tsx - real admin stats (devices, online now, trips today, records today), hourly chart, live event feed
  - [x] app/dashboard/page.tsx - real client dashboard (4 stats, live map, vehicle status sidebar)
- [x] Task 4: Map integration
  - [x] npm install react-leaflet leaflet @types/leaflet --legacy-peer-deps
  - [x] components/map.tsx - Leaflet map with custom SVG markers (color-coded by status), client-side only
  - [x] dashboard/page.tsx uses dynamic import (ssr: false) for map

## Files Created/Modified
- .env.local → correct Supabase credentials
- lib/supabase.ts → Supabase client
- lib/types.ts → TypeScript types (Device, TelemetryData, Trip, getDeviceStatus)
- app/layout.tsx → fonts changed to Bodoni Moda + Carme
- app/admin/page.tsx → FULLY WIRED (real stats, hourly chart, live event feed, auto-refresh)
- app/admin/devices/page.tsx → FULLY WIRED (real device list, search, auto-refresh)
- app/dashboard/page.tsx → FULLY WIRED (stats, Leaflet map, vehicle sidebar, auto-refresh 15s)
- app/dashboard/vehicles/page.tsx → FULLY WIRED (real fleet list with speed/position)
- app/dashboard/trips/page.tsx → FULLY WIRED (TS→TD→TE trip reconstruction)
- components/map.tsx → NEW: Leaflet map component (no SSR, custom SVG markers, auto-fit bounds)

## Map Component Details (components/map.tsx)
- Dynamic import with ssr:false in dashboard/page.tsx
- Loads Leaflet CSS from CDN (unpkg.com/leaflet@1.9.4)
- Custom SVG div markers: blue=#00AEEF (online), gold=#F5C400 (idle), gray=#B3B3B3 (offline)
- Auto-fits bounds to all visible markers (padding 40px, maxZoom 14)
- Default center: Doha Qatar (25.2, 51.5)
- Popup shows: device_id, status, speed, coordinates, last_seen time

## Auto-Refresh Intervals
- admin/page.tsx: 30s
- admin/devices/page.tsx: 30s
- dashboard/page.tsx: 15s
- dashboard/vehicles/page.tsx: 15s
- dashboard/trips/page.tsx: manual refresh only

## Pending Tasks
- [ ] Task 5: API routes (app/api/devices/route.ts, app/api/telemetry/route.ts) - optional
- [ ] Geofencing page
- [ ] Trip replay map (show polyline of route from TD records)
- [ ] Alerts/events page
- [ ] Subscription/billing management pages

## Running the Dev Server
cd /Users/santhoshvargheese/Projects/fleetpulse/FleetPulse
npm run dev
# Opens at http://localhost:3000
# Admin: /admin
# Dashboard: /dashboard

## Recovery Instructions
If session breaks, tell Claude:
"Continue FleetPulse web portal development.
Project is at /Users/santhoshvargheese/Projects/fleetpulse/FleetPulse/
Read CLAUDE_NOTES.md for full context.
All main pages are now wired to real Supabase data with live map.
Pending: API routes, trip replay map, geofencing, alerts pages."
